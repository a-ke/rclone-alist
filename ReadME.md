# rclone + Alist 增量备份脚本 (Python版)

这是一个使用 Python 编写的功能强大的 `rclone` 增量备份脚本，特别适用于将本地文件备份到 Alist 或其他 `rclone` 支持的云存储。

脚本的核心思想是通过在本地维护一个文件状态的“快照”，来代替 `rclone sync/copy` 每次运行时对远端存储的大量扫描。这使得它在处理海量文件时，能够极大地提升效率、减少 API 调用次数并缩短执行时间。

## 主要功能

  - **高效增量备份**：通过本地文件快照机制，仅上传/更新本地有变动的文件，无需扫描远端目录，速度极快。
  - **断点续传**：如果脚本中途意外中断，下次运行时会自动从上次中断的地方继续，保证数据一致性。
  - **灵活的同步策略**：
      - **保护模式**：可设置为从不删除任何远端文件，只进行追加和更新。
      - **回收站模式**：删除本地文件时，远端对应文件将被移入指定的回收站目录，而不是直接删除。
  - **自动化管理**：
      - **远端回收站清理**：自动删除超过指定保留天数的回收站文件。
      - **定期全量校验**：可配置定期（如每月一次）使用 `rclone check` 对比本地与远端的完整性，并可选择自动修复差异。
      - **日志自动清理**：自动删除旧的本地日志文件。
  - **健壮性设计**：
      - **单例执行**：通过文件锁机制，确保任何时候只有一个脚本实例在运行，防止任务重复执行造成冲突。
      - **丰富的日志**：所有操作都会记录在按天生成的日志文件中，且解决了终端和文件中的中文乱码问题。
  - **消息通知**：支持通过 Telegram 或邮件发送任务完成的摘要通知。
  - **高度可配置**：几乎所有参数，包括同步目录、忽略规则、rclone 参数、各种策略等，都可以在脚本顶部进行配置。

## 工作原理

脚本并非简单地包装 `rclone sync` 命令。它的工作流程如下：

1.  **首次运行**：

      - 扫描指定的本地目录，获取所有文件的列表（相对路径、大小、修改时间）。
      - 逐一将本地文件上传到远端。
      - 在本地 `cache` 目录下生成一个 `.snapshot` 快照文件，记录下所有已成功上传的文件信息。

2.  **后续运行**：

      - 再次扫描本地目录，获取当前的文件列表。
      - 将当前列表与 `.snapshot` 快照文件进行对比：
          - **新增文件**：如果在当前列表但不在快照中，则判定为新增，执行上传。
          - **修改文件**：如果在两边都在，但大小或修改时间不一致，则判定为修改，执行上传。
          - **删除文件**：如果不在当前列表但在快照中，则判定为删除，执行远端删除或移入回收站。
      - 每成功完成一个文件操作（上传/删除），都会实时更新一个临时的 `.tmp` 快照文件。
      - 当所有同步任务完成后，用临时的快照文件覆盖旧的快照文件，完成本次同步周期。

这种机制的**最大优势**是避免了 `rclone` 对远端进行 `ls` 或 `check` 操作，同步决策完全基于本地快照，效率极高。

## 环境依赖

1.  **Python 3**：确保您的系统已安装 Python 3。
2.  **rclone**：脚本依赖 `rclone` 执行所有文件操作。请确保 `rclone` 已安装，并且已正确配置好您的远端存储（脚本中的 `REMOTE_NAME`）。
3.  **requests (可选)**：如果您启用了 Telegram 通知功能，需要安装此库。
    ```bash
    pip3 install requests
    ```

## 如何使用

1.  **下载脚本**：将代码保存为 `rclone_alist_backup.py` 或其他你喜欢的名字。

2.  **修改配置**：打开脚本文件，仔细修改 `=== 基础配置 ===` 到 `=== rclone 参数 ===` 之间的所有配置项。这是最重要的一步。

      - `SYNC_PAIRS`: 配置需要同步的目录对，格式为 `"本地绝对路径::远端子目录"`。
      - `EXCLUDES`: 全局忽略规则，使用 `.gitignore` 类似的通配符语法。
      - `REMOTE_NAME`: 您在 `rclone config` 中配置的远端名称。
      - `LOG_DIR`, `CACHE_DIR`: 日志和缓存目录，请确保脚本有权限读写。
      - `RCLONE_BIN`: `rclone` 可执行文件的绝对路径。
      - `PROTECT_MODE`, `REMOTE_TRASH`: 根据您的需求配置同步策略。
      - `ENABLE_NOTIFY`: 如果需要通知，请开启并配置好 `Telegram` 或 `Mail` 的相关参数。
      - `RCLONE_OPTS`: 配置 `rclone` 的通用参数，如并发数、带宽限制等。

3.  **赋予执行权限**：

    ```bash
    chmod +x rclone_alist_backup.py
    ```

4.  **运行脚本**：

    ```bash
    # 直接运行
    ./rclone_alist_backup.py

    # 或者通过 python 解释器运行
    python3 rclone_alist_backup.py
    ```

    建议首次运行手动执行，观察日志输出是否一切正常。

5.  **设置定时任务 (Cron)**：
    为了实现自动化备份，强烈建议使用 `crontab` 设置定时任务。

      - 执行 `crontab -e` 编辑定时任务。
      - 添加一行类似如下的配置，表示每天凌晨 2:30 执行备份：
        ```crontab
        30 2 * * * /path/to/your/script/rclone_alist_backup.py > /dev/null 2>&1
        ```
      - 请务必将 `/path/to/your/script/` 替换为脚本的实际绝对路径。

## 目录结构说明

脚本运行后，会在您配置的 `LOG_DIR` 和 `CACHE_DIR` 下生成一些文件：

  - `CACHE_DIR/`:

      - `*.snapshot`: **核心快照文件**。记录了每个同步任务中所有已成功同步的文件信息。**请勿手动编辑或删除此文件！**
      - `*.snapshot.tmp`: 临时快照文件。在任务执行过程中产生，任务成功后会重命名为 `.snapshot`。
      - `rclone_alist_backup.lock`: **锁文件**。用于防止脚本多实例同时运行。
      - `last_full_check`: 记录上次全量校验的时间。

  - `LOG_DIR/`:

      - `backup-YYYY-MM-DD.log`: 按天生成的详细运行日志。

## 注意事项

  - **缓存文件的重要性**：`CACHE_DIR` 下的 `.snapshot` 文件是实现增量同步的基石。如果误删，脚本会认为是一次全新的同步，可能会重新上传所有文件。请务必妥善保管此目录。
  - **首次同步**：当针对一个拥有大量文件的目录进行首次同步时，由于需要上传所有文件并建立初始快照，会耗时较长，这是正常现象。后续的增量同步会非常快。
  - **兼容性**：脚本中的文件锁使用了 `fcntl`，这是一个 POSIX 标准，在 Linux, macOS 等类 Unix 系统上可用，但在 Windows 上可能无法直接运行。
